# WordPress Sync для WSL Debian

## Обзор

Этот проект содержит два основных скрипта для полной синхронизации WordPress-сайта между производственным сервером и локальной средой разработки на WSL Debian:

1. **`wordpress-db-sync.sh`** – синхронизация базы данных с заменой URL
2. **`wordpress-files-sync.sh`** – синхронизация файлов WordPress (темы, плагины, медиафайлы и т.д.)

Скрипты разработаны для безопасной и надежной синхронизации, включая автоматическое резервное копирование перед любыми изменениями.

## Возможности

### Синхронизация базы данных:
- Экспорт базы данных с производственного сервера
- Автоматическое резервное копирование локальной базы данных
- Замена URL (с продакшн на локальный)
- Очистка кэша WordPress после завершения

### Синхронизация файлов:
- Синхронизация выбранных директорий (темы, плагины, загрузки и т.д.)
- Исключение ненужных файлов и директорий (кэш, временные файлы)
- Исправление прав доступа к файлам
- Подробное логирование всех операций

## Требования

- WSL с установленным Debian
- SSH-доступ к производственному серверу
- Установленный WP-CLI как на локальном, так и на удаленном сервере
- Установленный rsync в WSL

## Установка

1. Клонируйте или скачайте этот репозиторий в вашу локальную систему WSL:
   ```bash
   git clone https://github.com/yourusername/wordpress-sync-wsl.git
   cd wordpress-sync-wsl
   ```

2. Сделайте скрипты исполняемыми:
   ```bash
   chmod +x wordpress-db-sync.sh
   chmod +x wordpress-files-sync.sh
   ```

3. Настройте переменные в начале обоих скриптов:
   - `REMOTE_HOST` - адрес вашего производственного сервера
   - `REMOTE_USER` - пользователь SSH на сервере
   - `REMOTE_PORT` - порт SSH (обычно 22)
   - `REMOTE_PATH` - путь к директории WordPress на сервере
   - `LOCAL_PATH` - путь к директории WordPress в WSL
   - `PROD_URL` - URL производственного сайта
   - `LOCAL_URL` - URL локального сайта

## Использование

### Синхронизация базы данных

```bash
./wordpress-db-sync.sh
```

Этот скрипт:
1. Создаст резервную копию вашей локальной базы данных
2. Экспортирует базу данных с удаленного сервера
3. Импортирует её в локальную среду
4. Заменит все ссылки с производственных на локальные

### Синхронизация файлов

```bash
sudo ./wordpress-files-sync.sh
```

Рекомендуется запускать с правами sudo для правильного установления прав доступа к файлам.

Этот скрипт:
1. Создаст резервные копии локальных директорий
2. Синхронизирует файлы с удаленного сервера
3. Исправит права доступа к файлам
4. Очистит кэш WordPress

### Полная синхронизация

Для удобства вы можете создать третий скрипт (`wordpress-full-sync.sh`), который будет запускать оба скрипта последовательно:

```bash
#!/bin/bash
echo "==== Запуск полной синхронизации WordPress ===="

# Сначала синхронизируем файлы
echo "Шаг 1: Синхронизация файлов..."
sudo ./wordpress-files-sync.sh

# Затем синхронизируем базу данных
echo "Шаг 2: Синхронизация базы данных..."
./wordpress-db-sync.sh

echo "==== Синхронизация успешно завершена! ===="
```

Не забудьте сделать его исполняемым:
```bash
chmod +x wordpress-full-sync.sh
```

## Настройка SSH-ключей для беспарольного доступа

Для более удобного использования скриптов рекомендуется настроить SSH-аутентификацию по ключу:

```bash
# Генерация SSH-ключа (если его еще нет)
ssh-keygen -t rsa -b 4096

# Копирование публичного ключа на удаленный сервер
ssh-copy-id -p 22 username@your-server.com
```

## Расширенная настройка

### Автоматическое планирование синхронизации

Вы можете настроить регулярную синхронизацию с помощью cron:

1. Откройте crontab для редактирования:
   ```bash
   crontab -e
   ```

2. Добавьте строку для запуска скрипта по расписанию:
   ```
   # Каждый понедельник в 3:00 утра
   0 3 * * 1 /path/to/wordpress-full-sync.sh >> /path/to/sync-log.log 2>&1
   ```

### Настройка синхронизируемых директорий

В скрипте `wordpress-files-sync.sh` вы можете изменить массив `SYNC_DIRS` для синхронизации только нужных вам директорий, например:

```bash
SYNC_DIRS=(
    "wp-content/themes/your-theme"
    "wp-content/plugins/your-plugin"
    "wp-content/uploads"
)
```

### Исключение файлов из синхронизации

В скрипте `wordpress-files-sync.sh` вы можете расширить массив `EXCLUDE` для исключения дополнительных файлов из синхронизации:

```bash
EXCLUDE=(
    "wp-content/cache"
    "wp-content/upgrade"
    "wp-content/uploads/cache"
    ".git"
    "node_modules"
    ".sass-cache"
    "*.log"
    "wp-content/themes/*/node_modules"
    "wp-content/themes/*/.git"
    "wp-content/plugins/*/node_modules"
)
```

## Устранение неполадок

### Проблемы с подключением SSH

Если у вас возникают проблемы с SSH-подключением:

1. Проверьте подключение вручную:
   ```bash
   ssh -p REMOTE_PORT REMOTE_USER@REMOTE_HOST
   ```

2. Проверьте права доступа к SSH-ключу:
   ```bash
   chmod 600 ~/.ssh/id_rsa
   ```

### Ошибки WP-CLI

Если WP-CLI выдает ошибки:

1. Убедитесь, что WP-CLI установлен:
   ```bash
   wp --info
   ```

2. Если WP-CLI не установлен, установите его:
   ```bash
   curl -O https://raw.githubusercontent.com/wp-cli/builds/gh-pages/phar/wp-cli.phar
   chmod +x wp-cli.phar
   sudo mv wp-cli.phar /usr/local/bin/wp
   ```

### Проблемы с резервным копированием

Если скрипт не может создать резервную копию, проверьте:

1. Наличие достаточного свободного места на диске:
   ```bash
   df -h
   ```

2. Права доступа к директории для резервных копий:
   ```bash
   ls -la /path/to/backup/directory
   ```

## Безопасность

- Скрипты создают резервные копии перед любыми операциями
- Все резервные копии сохраняются с временной меткой для легкого восстановления
- Для дополнительной безопасности рекомендуется запускать скрипты в тестовом режиме перед использованием на важных сайтах

## Лицензия

Этот проект распространяется под лицензией MIT. Вы можете свободно использовать, изменять и распространять его при условии сохранения копирайта и условий лицензии.
